//
//  PickerTableViewCell.m
//
//  Created by Tom Fewster on 18/10/2011.
//  Copyright (c) 2011 __MyCompanyName__. All rights reserved.
//

#import "PickerTableViewCell.h"

@implementation PickerTableViewCell

@synthesize pickerValue;
@synthesize picker;
@synthesize delegate;

- (id)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier
{
    self = [super initWithStyle:style reuseIdentifier:reuseIdentifier];
    if (self) {
		self.picker = [[[UIPickerView alloc] initWithFrame:CGRectZero] autorelease];
		self.picker.showsSelectionIndicator = YES;
		self.picker.delegate = self;
		self.picker.dataSource = self;
		[self.picker selectRow:self.pickerValue inComponent:0 animated:YES];
    }
    return self;
}

- (id)initWithCoder:(NSCoder *)aDecoder {
    self = [super initWithCoder:aDecoder];
    if (self) {
		self.picker = [[[UIPickerView alloc] initWithFrame:CGRectZero] autorelease];
		self.picker.showsSelectionIndicator = YES;
		self.picker.delegate = self;
		self.picker.dataSource = self;
		[self.picker selectRow:self.pickerValue inComponent:0 animated:YES];
    }
    return self;
}

- (void)dealloc {
	self.picker = nil;
	[super dealloc];
}

- (UIView *)inputView {
	return self.picker;
}

- (void)setPickerValue:(NSUInteger)value {
	pickerValue = value;
	self.detailTextLabel.text = [Shoot shootStatusAsString:self.pickerValue];
}

- (BOOL)becomeFirstResponder {
	[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillShow:) name:UIKeyboardWillShowNotification object:nil];
	return [super becomeFirstResponder];
}

- (BOOL)resignFirstResponder {
	[[NSNotificationCenter defaultCenter] removeObserver:self name:UIKeyboardWillShowNotification object:nil];
	return [super resignFirstResponder];
}

- (void)setSelected:(BOOL)selected animated:(BOOL)animated
{
	[super setSelected:selected animated:animated];
	if (selected) {
		[self becomeFirstResponder];
	}
}

- (void)keyboardWillShow:(NSNotification*)notification {
	NSDictionary *userInfo = [notification userInfo];    

	CGRect keyboardRect = CGRectZero;
	keyboardRect.size = [self.picker sizeThatFits:CGSizeZero];
	keyboardRect.origin = CGPointZero;
	
	NSValue *animationDurationValue = [userInfo objectForKey:UIKeyboardAnimationDurationUserInfoKey];
    NSTimeInterval animationDuration;
    [animationDurationValue getValue:&animationDuration];
	 
	[UIView animateWithDuration:animationDuration animations:^{
		self.picker.frame = keyboardRect;
	} completion:^(BOOL finished) {
		[self.picker setNeedsLayout];
	}];
}

#pragma mark -
#pragma mark Respond to touch and become first responder.

- (BOOL)canBecomeFirstResponder {
	return YES;
}

#pragma mark -
#pragma mark UIKeyInput Protocol Methods

- (BOOL)hasText {
	return YES;
}

- (void)insertText:(NSString *)theText {
}

- (void)deleteBackward {
}

#pragma mark -
#pragma mark UIPickerViewDataSource

- (NSInteger)numberOfComponentsInPickerView:(UIPickerView *)pickerView {
	return 1;
}

- (NSInteger)pickerView:(UIPickerView *)pickerView numberOfRowsInComponent:(NSInteger)component {
	return [[Shoot shootStatus] count];
}

#pragma mark -
#pragma mark UIPickerViewDelegate

- (NSString *)pickerView:(UIPickerView *)pickerView titleForRow:(NSInteger)row forComponent:(NSInteger)component {
	return [[Shoot shootStatus] objectAtIndex:row];
}

- (CGFloat)pickerView:(UIPickerView *)pickerView rowHeightForComponent:(NSInteger)component {
	return 44.0f;
}

- (CGFloat)pickerView:(UIPickerView *)pickerView widthForComponent:(NSInteger)component {
	return pickerView.bounds.size.width - 20.0f;
}

- (void)pickerView:(UIPickerView *)pickerView didSelectRow:(NSInteger)row inComponent:(NSInteger)component {
	self.pickerValue = row;
	if (delegate && [delegate respondsToSelector:@selector(tableViewCell:didEndEditingWithPickerValue:)]) {
		[delegate tableViewCell:self didEndEditingWithStatus:self.pickerValue];
	}
}

@end
